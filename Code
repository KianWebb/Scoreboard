-NEW VERSION-

#include <WiFi.h>
#include <HTTPClient.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <time.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define BUTTON_PIN 0

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// WiFi
const char* ssid = "Kian's Smart";
const char* password = "SmartHomeDevices";

// Files
const char* scoreURL =
"https://raw.githubusercontent.com/KianWebb/Scoreboard/main/Main%20Score";

const char* gamesURL =
"https://raw.githubusercontent.com/KianWebb/Scoreboard/main/Games";

const unsigned long updateInterval = 120000;
unsigned long lastUpdateAttempt = 0;

// Match mode
bool matchMode = false;
time_t matchEpoch = 0;
String lastMatchDate = "";

// Display data
String teamName = "";
String scoreLine = "";
String scrollText = "";

// Scroll variables (used in BOTH modes now)
int scrollX = SCREEN_WIDTH;
int scrollDir = -1;
unsigned long lastScroll = 0;
unsigned long pauseStart = 0;
bool isPaused = false;

const int scrollSpeed = 20;
const int pauseDuration = 2000;

void setup() {
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  Serial.begin(115200);
  Wire.begin(21, 22);

  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
  display.setTextColor(SSD1306_WHITE);
  display.setTextWrap(false);

  showStartupScreen();
  connectWiFi();
  configTime(0, 0, "pool.ntp.org");

  updateScore();
}

void loop() {

  checkMatchDay();

  if (matchMode) {
    drawCountdown();
  } else {
    if (digitalRead(BUTTON_PIN) == LOW) {
      updateScore();
      delay(500);
    }

    if (millis() - lastUpdateAttempt >= updateInterval) {
      updateScore();
    }

    drawScoreboard();
  }
}

// ---------- MATCH CHECK ----------
void checkMatchDay() {
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) return;

  char dateStr[6];
  strftime(dateStr, sizeof(dateStr), "%d/%m", &timeinfo);

  int hour = timeinfo.tm_hour;

  if (hour >= 12 && String(dateStr) != lastMatchDate) {
    fetchGames(String(dateStr));
    lastMatchDate = String(dateStr);
  }
}

void fetchGames(String today) {

  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) return;

  HTTPClient http;
  http.begin(gamesURL);

  if (http.GET() == 200) {
    String data = http.getString();
    int start = 0;

    while (true) {
      int end = data.indexOf('\n', start);
      if (end == -1) break;

      String line = data.substring(start, end);

      if (line.startsWith(today)) {

        int c1 = line.indexOf(',');
        int c2 = line.indexOf(',', c1 + 1);
        int c3 = line.indexOf(',', c2 + 1);

        String fixture = line.substring(6, c1);
        String location = line.substring(c1 + 2, c2);
        String league = line.substring(c2 + 2, c3);
        String timeStr = line.substring(c3 + 2);

        int vIndex = fixture.indexOf("V");
        String opponent = fixture.substring(vIndex + 2);

        teamName = "Panthers V " + opponent;
        scrollText = location + " - " + league;

        struct tm matchTime = {0};
        matchTime.tm_mday = today.substring(0,2).toInt();
        matchTime.tm_mon  = today.substring(3,5).toInt() - 1;
        matchTime.tm_year = timeinfo.tm_year;
        matchTime.tm_hour = timeStr.substring(0,2).toInt();
        matchTime.tm_min  = timeStr.substring(3,5).toInt();
        matchTime.tm_sec  = 0;

        matchEpoch = mktime(&matchTime);
        matchMode = true;

        // Reset scroll
        scrollX = SCREEN_WIDTH;
        scrollDir = -1;
        isPaused = false;

        break;
      }

      start = end + 1;
    }
  }

  http.end();
}

// ---------- COUNTDOWN ----------
void drawCountdown() {
  time_t now = time(NULL);
  long diff = matchEpoch - now;

  if (diff <= 0) {
    matchMode = false;
    updateScore();
    return;
  }

  int hours = diff / 3600;
  int minutes = (diff % 3600) / 60;
  int seconds = diff % 60;

  char buffer[9];
  sprintf(buffer, "%02d:%02d:%02d", hours, minutes, seconds);

  display.clearDisplay();

  display.setTextSize(1);
  centerText(teamName, 0);

  display.setTextSize(2);
  centerText(String(buffer), 20);

  // ðŸ”¥ SCROLLING BOTTOM TEXT
  display.setTextSize(1);

  int16_t x1, y1;
  uint16_t w, h;
  display.getTextBounds(scrollText, 0, 0, &x1, &y1, &w, &h);

  display.setCursor(scrollX, 52);
  display.print(scrollText);

  unsigned long nowMillis = millis();

  if (isPaused) {
    if (nowMillis - pauseStart >= pauseDuration) {
      isPaused = false;
      scrollDir = -scrollDir;
    }
  } else if (nowMillis - lastScroll >= scrollSpeed) {
    scrollX += scrollDir;

    if (scrollX <= SCREEN_WIDTH - w) {
      scrollX = SCREEN_WIDTH - w;
      isPaused = true;
      pauseStart = nowMillis;
    }

    if (scrollX >= 0) {
      scrollX = 0;
      isPaused = true;
      pauseStart = nowMillis;
    }

    lastScroll = nowMillis;
  }

  display.display();
}

// ---------- NORMAL SCORE ----------
void updateScore() {
  lastUpdateAttempt = millis();

  HTTPClient http;
  http.begin(scoreURL);

  if (http.GET() == 200) {
    String data = http.getString();

    int a = data.indexOf('\n');
    int b = data.indexOf('\n', a + 1);

    teamName = data.substring(0, a);
    scoreLine = data.substring(a + 1, b);
    scrollText = data.substring(b + 1);

    scrollX = SCREEN_WIDTH;
    scrollDir = -1;
    isPaused = false;
  }

  http.end();
}

void drawScoreboard() {
  display.clearDisplay();

  display.setTextSize(1);
  centerText(teamName, 0);

  display.setTextSize(3);
  centerText(scoreLine, 18);

  display.setTextSize(1);

  int16_t x1, y1;
  uint16_t w, h;
  display.getTextBounds(scrollText, 0, 0, &x1, &y1, &w, &h);

  display.setCursor(scrollX, 52);
  display.print(scrollText);

  display.display();
}

// ---------- STARTUP ----------
void showStartupScreen() {
  unsigned long start = millis();
  unsigned long lastAnim = 0;
  int dotCount = 0;

  while (millis() - start < 6000) {
    if (millis() - lastAnim >= 500) {
      dotCount = (dotCount + 1) % 3;
      lastAnim = millis();
    }

    String title = "Starting";
    for (int i = 0; i < dotCount; i++) title += ".";

    display.clearDisplay();
    display.setTextSize(2);
    centerText(title, 10);

    display.setTextSize(1);
    centerText("scoreboard by kian", 46);

    display.display();
  }
}

void connectWiFi() {
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) delay(200);
}

void centerText(String text, int y) {
  int16_t x1, y1;
  uint16_t w, h;
  display.getTextBounds(text, 0, 0, &x1, &y1, &w, &h);
  display.setCursor((SCREEN_WIDTH - w) / 2, y);
  display.print(text);
}


-LAST VERSION-


#include <WiFi.h>
#include <HTTPClient.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define BUTTON_PIN 0   // BOOT button

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// WiFi credentials
const char* ssid = "Kian's Smart";
const char* password = "SmartHomeDevices";

// GitHub RAW file (UPDATED)
const char* scoreURL =
"https://raw.githubusercontent.com/KianWebb/Scoreboard/main/Main%20Score";

// Update timing (2 minutes)
unsigned long lastUpdateAttempt = 0;
const unsigned long updateInterval = 120000;

// Score data
String teamName = "";
String scoreLine = "";
String scrollText = "";

// Scrolling variables
int scrollX = SCREEN_WIDTH;
int scrollDir = -1;
unsigned long lastScroll = 0;
unsigned long pauseStart = 0;
bool isPaused = false;

const int scrollSpeed = 20;
const int pauseDuration = 2000;

void setup() {
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  Serial.begin(115200);
  Wire.begin(21, 22);

  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
  display.setTextColor(SSD1306_WHITE);
  display.setTextWrap(false);

  showStartupScreen();
  connectWiFi();
  updateScore();
}

void loop() {
  // Manual update (BOOT button)
  if (digitalRead(BUTTON_PIN) == LOW) {
    updateScore();
    delay(500);
  }

  // Timed update
  if (millis() - lastUpdateAttempt >= updateInterval) {
    updateScore();
  }

  drawScoreboard();
}

// ---------- STARTUP ----------
void showStartupScreen() {
  unsigned long start = millis();
  unsigned long lastAnim = 0;
  int dotCount = 0;

  while (millis() - start < 6000) {
    unsigned long now = millis();

    if (now - lastAnim >= 500) {
      dotCount = (dotCount + 1) % 3;  // 0â€“2 dots only
      lastAnim = now;
    }

    String title = "Starting";
    for (int i = 0; i < dotCount; i++) title += ".";

    display.clearDisplay();
    display.setTextSize(2);
    centerText(title, 10);

    display.setTextSize(1);
    centerText("scoreboard by kian", 46);

    display.display();
    delay(30);
  }
}

// ---------- WIFI ----------
void connectWiFi() {
  WiFi.begin(ssid, password);
  unsigned long startAttempt = millis();

  while (WiFi.status() != WL_CONNECTED && millis() - startAttempt < 6000) {
    delay(200);
  }
}

// ---------- FETCH SCORE ----------
void updateScore() {
  lastUpdateAttempt = millis();

  if (WiFi.status() != WL_CONNECTED) {
    WiFi.reconnect();
    return;
  }

  HTTPClient http;
  http.begin(scoreURL);
  int httpCode = http.GET();

  if (httpCode == 200) {
    String data = http.getString();

    int a = data.indexOf('\n');
    int b = data.indexOf('\n', a + 1);

    teamName = data.substring(0, a);
    scoreLine = data.substring(a + 1, b);
    scrollText = data.substring(b + 1);

    scrollX = SCREEN_WIDTH;
    scrollDir = -1;
    isPaused = false;
  }

  http.end();
}

// ---------- DRAW ----------
void drawScoreboard() {
  display.clearDisplay();

  // Team name
  display.setTextSize(1);
  centerText(teamName, 0);

  // BIG score
  display.setTextSize(3);
  centerText(scoreLine, 18);

  // Scrolling bottom text
  display.setTextSize(1);

  int16_t x1, y1;
  uint16_t w, h;
  display.getTextBounds(scrollText, 0, 0, &x1, &y1, &w, &h);

  display.setCursor(scrollX, 52);
  display.print(scrollText);

  unsigned long now = millis();

  if (isPaused) {
    if (now - pauseStart >= pauseDuration) {
      isPaused = false;
      scrollDir = -scrollDir;
    }
  } else if (now - lastScroll >= scrollSpeed) {
    scrollX += scrollDir;

    if (scrollX <= SCREEN_WIDTH - w) {
      scrollX = SCREEN_WIDTH - w;
      isPaused = true;
      pauseStart = now;
    }

    if (scrollX >= 0) {
      scrollX = 0;
      isPaused = true;
      pauseStart = now;
    }

    lastScroll = now;
  }

  display.display();
}

// ---------- CENTER TEXT ----------
void centerText(String text, int y) {
  int16_t x1, y1;
  uint16_t w, h;
  display.getTextBounds(text, 0, 0, &x1, &y1, &w, &h);
  display.setCursor((SCREEN_WIDTH - w) / 2, y);
  display.print(text);
}